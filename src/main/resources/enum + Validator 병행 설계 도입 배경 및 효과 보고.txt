enum + Validator 병행 설계 도입 배경 및 효과 보고
1. 개요
본 문서는 당사 보고/집계 API에서 적용한
enum 기반 컬럼 검증과 AST 기반 SQL Validator를 병행하는 구조의 도입 배경과 효과를 설명한다.

해당 구조는 단순한 SQL Injection 방어를 넘어서,
실무에서 빈번히 발생하는 alias 우회, 동적 SQL 오용, 조건 무력화 쿼리를 구조적으로 차단하는 것을 목표로 한다.

2. 기존 방식의 한계 (문제 인식)
2.1 enum만 사용하는 경우의 한계
기존 구조에서는 다음과 같은 방식이 일반적이었다.

컨트롤러 단에서

요청 파라미터(selectColumns, orderByColumns 등)를

enum(화이트리스트)으로 검증

TOTAL_REVENUE, ENTERPRISE_ID, INDUSTRY_CODE ...
이 방식은 API 계약 안정성에는 효과적이나,
다음과 같은 보안 취약점을 해결하지 못한다.

문제 사례 (alias 우회)
SELECT password AS total_revenue FROM users
요청 파라미터: TOTAL_REVENUE

enum 검증: 통과

실제 접근 컬럼: password (민감 정보)

👉 enum 기준 검증만으로는 실제 데이터 접근을 검증할 수 없음

2.2 SQL 문자열 기반 검증의 한계
정규식 또는 문자열 검색 기반 검증은:

서브쿼리

alias

함수

UNION / EXISTS

괄호 중첩

등이 포함된 실무 SQL에서 정확성과 유지보수성이 급격히 저하된다.

3. 개선 방향: 역할 분리 기반 2단계 검증 구조
본 프로젝트에서는 검증 책임을 명확히 분리하였다.

4. 1단계: enum 기반 검증 (컨트롤러 / 서비스 레벨)
4.1 역할 정의
enum 검증의 역할은 다음과 같다.

“이 API에서 어떤 출력 컬럼을 요청할 수 있는가?”

즉, 출력 스키마(API 계약) 를 검증한다.

4.2 적용 대상
selectColumns

groupByColumns

orderByColumns

4.3 효과
항목	효과
API 안정성	허용되지 않은 컬럼 요청 차단
SQL Injection	${} 기반 동적 SQL 차단
유지보수	컬럼 변경 시 enum만 관리
계약 명확화	API 스펙이 코드로 고정됨
📌 중요:
이 단계는 보안 검증이 아니라 “API 입력 검증”에 가깝다.

5. 2단계: AST 기반 Validator (SQL 실행 직전)
5.1 역할 정의
Validator의 역할은 다음과 같다.

“이 SQL이 실제로 어떤 테이블과 컬럼에 접근하는가?”

즉, 실제 데이터 접근(lineage) 을 검증한다.

5.2 구현 방식
JSqlParser 기반 AST 파싱

SQL을 구조적으로 해석

다음 메타 정보 수집:

실제 사용 컬럼 (columns)

SELECT 결과 컬럼 (rootColumns)

사용 테이블

OR / 조건 무력화 패턴

서브쿼리 전파

5.3 차단 가능한 공격 유형
공격 유형	차단 여부
alias로 민감 컬럼 위장	✅
서브쿼리 은폐	✅
OR '1'='1' 조건 무력화	✅
EXISTS 기반 우회	✅
함수(SUM, MAX)로 민감 컬럼 접근	✅
6. enum + Validator 병행의 핵심 이유
6.1 단일 방식으로는 해결 불가
방식	한계
enum 단독	실제 DB 접근 컬럼을 알 수 없음
Validator 단독	API 요청 계약을 보장하지 못함
6.2 병행 구조의 시너지
단계	책임
enum	“보여줘도 되는 결과 컬럼인가?”
validator	“읽어도 되는 실제 컬럼인가?”
이 구조를 통해:

출력과 접근을 명확히 분리

alias 우회 공격 구조적으로 차단

실무 SQL 패턴(WHERE 1=1, 복잡한 JOIN) 유지 가능

7. 설계 효과 요약
기술적 효과
동적 SQL 사용 가능하면서도 안전

SQL 복잡도 증가에도 검증 정확도 유지

서브쿼리 포함 쿼리까지 일관된 정책 적용

조직적 효과
보안 정책을 코드로 명확히 표현

신규 개발자도 규칙을 자연스럽게 따르게 됨

“보안 때문에 개발이 느리다”는 인식 감소

8. 결론
본 구조는 단순한 SQL Injection 방어를 넘어,

“출력은 허용되었으나, 접근은 허용되지 않은 컬럼”을
구조적으로 차단하는 실무형 보안 설계

이다.

enum과 validator를 병행함으로써
유연성과 보안성을 동시에 확보할 수 있으며,
복잡한 리포트/집계 시스템에 적합한 구조로 판단된다.