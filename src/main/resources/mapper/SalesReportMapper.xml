<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.report.mapper.SalesReportMapper">

    <select id="selectSalesReport" resultType="map">
        SELECT
            ${selectColumns},
            COUNT(cf.customer_id) AS total_managed_customers,
            ROUND(AVG(cf.monthly_subscription), 2) AS avg_monthly_subscription,
            SUM(cf.total_ltv) AS portfolio_value,

            /* ðŸ”§ MONTHS_BETWEEN ì œê±° (H2 í…ŒìŠ¤íŠ¸ìš©) */
            ROUND(
                AVG(
                    DATEDIFF('MONTH', sr.hire_date, CURRENT_DATE)
                ),
                0
            ) AS avg_rep_tenure_months,

            ROUND(
                AVG(
                    COALESCE(cs.negative_trend_months * 10, 0)
                    + (cf.overdue_count * 5)
                ),
                1
            ) AS avg_risk_score
        FROM
            CustomerFinancials cf
        JOIN
            sales_reps sr ON cf.sales_rep_id = sr.rep_id
        JOIN
            regions r ON sr.region_id = r.region_id
        LEFT JOIN
            ChurnSignals cs ON cf.customer_id = cs.customer_id
        GROUP BY
            ${groupByColumns}
        ${orderByClause}
    </select>

</mapper>
