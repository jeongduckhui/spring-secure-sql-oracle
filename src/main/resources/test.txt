// [í”„ë¡ íŠ¸ì—”ë“œ] example.js (ë˜ëŠ” Vue/React ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€)

import axios from 'axios';

// ë°±ì—”ë“œë¡œ ì „ì†¡í•  íŒŒë¼ë¯¸í„° ê°ì²´
const params = {
    "colA": 'TEST_VALUE_123',
    // SELECT ì ˆì— ë“¤ì–´ê°ˆ ì»¬ëŸ¼ ëª©ë¡ (ê·¸ë£¹í™” ì»¬ëŸ¼ + ì§‘ê³„ ì»¬ëŸ¼)
    "columnList": 'COL_A, COL_B, SUM(COL_C) AS TOTAL_C', 
    // GROUP BY ì ˆì— ë“¤ì–´ê°ˆ ì»¬ëŸ¼ ëª©ë¡ (ìˆœìˆ˜í•œ ê·¸ë£¹í™” ê¸°ì¤€ ì»¬ëŸ¼ë§Œ)
    "groupByList": 'COL_A, COL_B' 
};

// ë°±ì—”ë“œ API í˜¸ì¶œ í•¨ìˆ˜
async function fetchAggregatedData() {
    try {
        const response = await axios.post('/api/data/aggregate', params, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log("ì¡°íšŒ ì„±ê³µ:", response.data);
        return response.data;
        
    } catch (error) {
        console.error("API í˜¸ì¶œ ì‹¤íŒ¨:", error);
    }
}

// í•¨ìˆ˜ ì‹¤í–‰ ì˜ˆì‹œ
// fetchAggregatedData();

========================================================================

// [ë°±ì—”ë“œ] com.example.demo.controller.DataController.java

package com.example.demo.controller;

import com.example.demo.service.DataService;
import org.springframework.web.bind.annotation.*;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/data")
public class DataController {

    @Autowired
    private DataService dataService;

    @PostMapping("/aggregate")
    public List<Map<String, Object>> getAggregatedData(@RequestBody Map<String, Object> requestMap) {
        
        // requestMapì—ëŠ” ì´ì œ 'colA', 'columnList', 'groupByList' ì„¸ ê°œì˜ í‚¤ê°€ í¬í•¨ë©ë‹ˆë‹¤.
        return dataService.getAggregatedData(requestMap);
    }
}

========================================================================

// [ë°±ì—”ë“œ] com.example.demo.service.DataService.java

package com.example.demo.service;

import com.example.demo.mapper.DataMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

@Service
public class DataService {

    @Autowired
    private DataMapper dataMapper;

    public List<Map<String, Object>> getAggregatedData(Map<String, Object> params) {
        
        // ******************************************************************
        // ì¤‘ìš”: ë³´ì•ˆ ë° ìœ íš¨ì„± ê²€ì¦ ë¡œì§ (í•„ìˆ˜)
        // 1. í•„ìˆ˜ í‚¤(colA, columnList, groupByList) ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬.
        // 2. columnListì™€ groupByListì— SQL Injection ìš”ì†Œ(í•¨ìˆ˜, í‚¤ì›Œë“œ ë“±)ê°€ ì—†ëŠ”ì§€ 
        //    ë³„ë„ì˜ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ ê²€ì¦ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
        // ******************************************************************
        
        // ê²€ì¦ í›„ Mapperì— Mapì„ ê·¸ëŒ€ë¡œ ì „ë‹¬
        return dataMapper.selectAggregatedData(params);
    }
}

========================================================================

// [ë°±ì—”ë“œ] com.example.demo.mapper.DataMapper.java

package com.example.demo.mapper;

import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Map;

@Mapper
@Repository
public interface DataMapper {

    // íŒŒë¼ë¯¸í„° íƒ€ì…ì„ Mapìœ¼ë¡œ ìœ ì§€
    List<Map<String, Object>> selectAggregatedData(Map<String, Object> params);
}

========================================================================

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.DataMapper">

    <select id="selectAggregatedData" 
            parameterType="java.util.Map"
            resultType="java.util.Map">
        
        SELECT 
            -- SELECT ì ˆ: ê·¸ë£¹í™” ì»¬ëŸ¼ + ì§‘ê³„ ì»¬ëŸ¼ (ì˜ˆ: COL_A, COL_B, SUM(COL_C) AS TOTAL_C)
            ${columnList}
        FROM TABLE_A
        WHERE 1=1
            AND COL_A = #{colA}
        
        -- GROUP BY ì ˆ: ìˆœìˆ˜í•œ ê·¸ë£¹í™” ê¸°ì¤€ ì»¬ëŸ¼ë§Œ ì‚¬ìš© (ì˜ˆ: COL_A, COL_B)
        GROUP BY ${groupByList}
        
        -- ORDER BY ì ˆ: SELECT ì ˆì˜ ì»¬ëŸ¼ ë˜ëŠ” ë³„ì¹­ì„ ì‚¬ìš© (COL_A, COL_B, TOTAL_C ëª¨ë‘ ê°€ëŠ¥)
        ORDER BY ${columnList}
    </select>
</mapper>

========================================================================

// [ë°±ì—”ë“œ] com.example.demo.mapper.DataMapperTest.java (Test ì½”ë“œ)

package com.example.demo.mapper;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@SpringBootTest 
@Transactional 
public class DataMapperTest {

    @Autowired
    private DataMapper dataMapper;

    @Test
    void shouldExecuteAggregatedQueryWithSeparateLists() {
        
        // 1. í…ŒìŠ¤íŠ¸ ì…ë ¥ ê°’ ì¤€ë¹„ (HashMap ì‚¬ìš©)
        Map<String, Object> params = new HashMap<>();
        params.put("colA", "TEST_VALUE_A"); 
        
        // ğŸš¨ ë¶„ë¦¬ëœ íŒŒë¼ë¯¸í„° ì„¤ì •
        params.put("columnList", "COL_A, COL_B, SUM(COL_C) AS TOTAL_C");
        params.put("groupByList", "COL_A, COL_B"); 
        
        // 2. Mapper ì‹¤í–‰
        List<Map<String, Object>> results = dataMapper.selectAggregatedData(params);

        // 3. ê²°ê³¼ ê²€ì¦ (Assertion)
        if (results != null && !results.isEmpty()) {
            System.out.println("--- Test Query Results (Map, Separated Lists) ---");
            for (Map<String, Object> row : results) {
                // COL_Aì™€ TOTAL_C (SUMì˜ ë³„ì¹­) ê²°ê³¼ í™•ì¸
                System.out.println("COL_A: " + row.get("COL_A") + ", TOTAL_C: " + row.get("TOTAL_C"));
            }
            System.out.println("--------------------------------------------------");
        }
        
        // Assertions.assertNotNull(results);
    }
}



















































